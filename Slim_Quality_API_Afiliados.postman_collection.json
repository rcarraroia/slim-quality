{
  "info": {
    "name": "Slim Quality - API Afiliados",
    "description": "Coleção completa para testar a API de afiliados do sistema Slim Quality",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
    "_postman_id": "slim-quality-affiliates-api",
    "version": "1.0.0"
  },
  "variable": [
    {
      "key": "base_url",
      "value": "http://localhost:3000",
      "type": "string"
    },
    {
      "key": "api_url",
      "value": "{{base_url}}/api",
      "type": "string"
    },
    {
      "key": "affiliate_id",
      "value": "",
      "type": "string"
    },
    {
      "key": "referral_code",
      "value": "",
      "type": "string"
    },
    {
      "key": "order_id",
      "value": "",
      "type": "string"
    },
    {
      "key": "withdrawal_id",
      "value": "",
      "type": "string",
      "description": "ID do saque criado"
    },
    {
      "key": "auth_token",
      "value": "",
      "type": "string",
      "description": "Token JWT do Supabase Auth para autenticação"
    },
    {
      "key": "asaas_webhook_token",
      "value": "seu_token_aqui",
      "type": "string",
      "description": "Token configurado no .env como ASAAS_WEBHOOK_TOKEN"
    }
  ],
  "item": [
    {
      "name": "Afiliados",
      "item": [
        {
          "name": "Listar Todos Afiliados",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{api_url}}/affiliates",
              "host": ["{{api_url}}"],
              "path": ["affiliates"]
            },
            "description": "Lista todos os afiliados cadastrados no sistema"
          },
          "response": []
        },
        {
          "name": "Buscar Afiliado por ID",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{api_url}}/affiliates/:id",
              "host": ["{{api_url}}"],
              "path": ["affiliates", ":id"],
              "variable": [
                {
                  "key": "id",
                  "value": "{{affiliate_id}}",
                  "description": "ID do afiliado"
                }
              ]
            },
            "description": "Busca um afiliado específico pelo ID"
          },
          "response": []
        },
        {
          "name": "Buscar por Código/Slug de Indicação",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{api_url}}/affiliates/referral/:code",
              "host": ["{{api_url}}"],
              "path": ["affiliates", "referral", ":code"],
              "variable": [
                {
                  "key": "code",
                  "value": "{{referral_code}}",
                  "description": "Código de indicação ou slug"
                }
              ]
            },
            "description": "Busca afiliado pelo código de indicação ou slug (formato simplificado)"
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code é 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Retorna dados do afiliado', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property('id');",
                  "    pm.expect(jsonData).to.have.property('name');",
                  "    pm.expect(jsonData).to.have.property('referral_code');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "Criar Afiliado",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"name\": \"João Silva\",\n  \"email\": \"joao@example.com\",\n  \"phone\": \"11999999999\",\n  \"wallet_id\": \"wal_abc123\",\n  \"sponsor_referral_code\": null\n}"
            },
            "url": {
              "raw": "{{api_url}}/affiliates",
              "host": ["{{api_url}}"],
              "path": ["affiliates"]
            },
            "description": "Cria um novo afiliado no sistema"
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code é 201', function () {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "",
                  "pm.test('Afiliado criado com sucesso', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property('id');",
                  "    pm.expect(jsonData).to.have.property('referral_code');",
                  "    ",
                  "    // Salvar ID e código para próximos testes",
                  "    pm.collectionVariables.set('affiliate_id', jsonData.id);",
                  "    pm.collectionVariables.set('referral_code', jsonData.referral_code);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Hierarquia (Bug 01)",
      "item": [
        {
          "name": "Buscar Rede do Afiliado",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{api_url}}/affiliates/:id/network",
              "host": ["{{api_url}}"],
              "path": ["affiliates", ":id", "network"],
              "variable": [
                {
                  "key": "id",
                  "value": "{{affiliate_id}}",
                  "description": "ID do afiliado"
                }
              ]
            },
            "description": "Busca a rede genealógica do afiliado (3 níveis)"
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code é 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Retorna estrutura de rede', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.be.an('array');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "Buscar Ancestrais (N2, N3)",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{api_url}}/affiliates/:id/ancestors",
              "host": ["{{api_url}}"],
              "path": ["affiliates", ":id", "ancestors"],
              "variable": [
                {
                  "key": "id",
                  "value": "{{affiliate_id}}",
                  "description": "ID do afiliado"
                }
              ]
            },
            "description": "Busca os ancestrais do afiliado (N2 e N3) para cálculo de comissões"
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code é 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Retorna ancestrais corretos', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property('n2');",
                  "    pm.expect(jsonData).to.have.property('n3');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Comissões (Bugs 04, 05)",
      "item": [
        {
          "name": "Listar Comissões do Afiliado",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{api_url}}/affiliates/:id/commissions",
              "host": ["{{api_url}}"],
              "path": ["affiliates", ":id", "commissions"],
              "variable": [
                {
                  "key": "id",
                  "value": "{{affiliate_id}}",
                  "description": "ID do afiliado"
                }
              ]
            },
            "description": "Lista todas as comissões do afiliado"
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code é 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Retorna lista de comissões', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.be.an('array');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "Processar Comissões de Pedido",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"order_id\": \"{{order_id}}\"\n}"
            },
            "url": {
              "raw": "{{api_url}}/commissions/process",
              "host": ["{{api_url}}"],
              "path": ["commissions", "process"]
            },
            "description": "Processa comissões de um pedido (Bug 04 - RPC implementada)"
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code é 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Comissões processadas corretamente', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property('success', true);",
                  "    pm.expect(jsonData).to.have.property('commissions');",
                  "    ",
                  "    // Validar valores (Bug 05)",
                  "    var commissions = jsonData.commissions;",
                  "    pm.expect(commissions).to.be.an('array');",
                  "    ",
                  "    // Verificar se percentuais estão corretos",
                  "    commissions.forEach(function(commission) {",
                  "        pm.expect(commission).to.have.property('level');",
                  "        pm.expect(commission).to.have.property('amount_cents');",
                  "        pm.expect(commission).to.have.property('percentage');",
                  "    });",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Dashboard (Bug 02)",
      "item": [
        {
          "name": "Métricas do Afiliado",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{api_url}}/affiliates/:id/metrics",
              "host": ["{{api_url}}"],
              "path": ["affiliates", ":id", "metrics"],
              "variable": [
                {
                  "key": "id",
                  "value": "{{affiliate_id}}",
                  "description": "ID do afiliado"
                }
              ]
            },
            "description": "Busca métricas do dashboard do afiliado (Bug 02 - corrigido)"
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code é 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Métricas calculadas corretamente', function () {",
                  "    var jsonData = pm.response.json();",
                  "    ",
                  "    // Validar estrutura",
                  "    pm.expect(jsonData).to.have.property('total_sales');",
                  "    pm.expect(jsonData).to.have.property('total_commissions');",
                  "    pm.expect(jsonData).to.have.property('total_referrals');",
                  "    pm.expect(jsonData).to.have.property('conversion_rate');",
                  "    ",
                  "    // Validar tipos (Bug 08 - formatação monetária)",
                  "    pm.expect(jsonData.total_sales).to.be.a('number');",
                  "    pm.expect(jsonData.total_commissions).to.be.a('number');",
                  "    pm.expect(jsonData.total_referrals).to.be.a('number');",
                  "    pm.expect(jsonData.conversion_rate).to.be.a('number');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Rastreamento (Bug 03)",
      "item": [
        {
          "name": "Registrar Click de Indicação (Vercel)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"referralCode\": \"{{referral_code}}\",\n  \"url\": \"https://slimquality.com.br\",\n  \"userAgent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36\",\n  \"referer\": \"https://google.com\",\n  \"utmSource\": \"instagram\",\n  \"utmMedium\": \"social\",\n  \"utmCampaign\": \"lancamento\",\n  \"utmContent\": \"post-organico\",\n  \"utmTerm\": \"colchao-magnetico\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/referral/track-click",
              "host": ["{{base_url}}"],
              "path": ["api", "referral", "track-click"]
            },
            "description": "Registra um click no link de indicação via Vercel Serverless Function (Bug 03 - rastreamento)"
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code é 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Click registrado com sucesso', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property('success', true);",
                  "    pm.expect(jsonData).to.have.property('message');",
                  "    pm.expect(jsonData).to.have.property('clickId');",
                  "});",
                  "",
                  "pm.test('Retorna ID do click registrado', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.clickId).to.be.a('string');",
                  "    pm.expect(jsonData.clickId).to.not.be.empty;",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "Track Click - Sem Código (deve falhar)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"userAgent\": \"Mozilla/5.0\",\n  \"referer\": \"https://google.com\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/referral/track-click",
              "host": ["{{base_url}}"],
              "path": ["api", "referral", "track-click"]
            },
            "description": "Testa validação - deve retornar erro 400 quando referralCode não é fornecido"
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code é 400 (sem código)', function () {",
                  "    pm.response.to.have.status(400);",
                  "});",
                  "",
                  "pm.test('Mensagem de erro apropriada', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property('success', false);",
                  "    pm.expect(jsonData).to.have.property('error');",
                  "    pm.expect(jsonData.error).to.include('obrigatório');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "Track Click - Código Inválido",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"referralCode\": \"CODIGO_INEXISTENTE_123\",\n  \"userAgent\": \"Mozilla/5.0\",\n  \"referer\": \"https://google.com\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/referral/track-click",
              "host": ["{{base_url}}"],
              "path": ["api", "referral", "track-click"]
            },
            "description": "Testa validação - deve retornar erro 404 quando afiliado não existe"
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code é 404 (código inválido)', function () {",
                  "    pm.response.to.have.status(404);",
                  "});",
                  "",
                  "pm.test('Mensagem de erro apropriada', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property('success', false);",
                  "    pm.expect(jsonData).to.have.property('error');",
                  "    pm.expect(jsonData.error).to.include('não encontrado');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "Track Click - Método Inválido (GET)",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/api/referral/track-click",
              "host": ["{{base_url}}"],
              "path": ["api", "referral", "track-click"]
            },
            "description": "Testa validação - deve retornar erro 405 quando método não é POST"
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code é 405 (método não permitido)', function () {",
                  "    pm.response.to.have.status(405);",
                  "});",
                  "",
                  "pm.test('Mensagem de erro apropriada', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property('success', false);",
                  "    pm.expect(jsonData).to.have.property('error');",
                  "    pm.expect(jsonData.error).to.include('não permitido');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "Track Click - Com UTM Completo",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"referralCode\": \"{{referral_code}}\",\n  \"url\": \"https://slimquality.com.br/produtos/colchao-padrao\",\n  \"userAgent\": \"Mozilla/5.0 (iPhone; CPU iPhone OS 14_0 like Mac OS X)\",\n  \"referer\": \"https://facebook.com\",\n  \"utmSource\": \"facebook\",\n  \"utmMedium\": \"cpc\",\n  \"utmCampaign\": \"black-friday-2026\",\n  \"utmContent\": \"anuncio-video\",\n  \"utmTerm\": \"colchao-ortopedico\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/referral/track-click",
              "host": ["{{base_url}}"],
              "path": ["api", "referral", "track-click"]
            },
            "description": "Testa tracking completo com todos os parâmetros UTM para análise de marketing"
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code é 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Click com UTM registrado com sucesso', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property('success', true);",
                  "    pm.expect(jsonData).to.have.property('clickId');",
                  "});",
                  "",
                  "pm.test('Validar que dados UTM foram capturados', function () {",
                  "    // Verificar que o click foi registrado",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.success).to.be.true;",
                  "    ",
                  "    // Nota: Os dados UTM são salvos no banco, mas não retornados na resposta",
                  "    // Para validar, seria necessário consultar o banco ou criar endpoint de consulta",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Webhook Asaas",
      "item": [
        {
          "name": "Webhook - SEM Token (deve falhar)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"event\": \"PAYMENT_CONFIRMED\",\n  \"payment\": {\n    \"id\": \"pay_test123\",\n    \"value\": 3290.00,\n    \"status\": \"CONFIRMED\",\n    \"customer\": \"cus_test456\",\n    \"externalReference\": \"order_789\"\n  }\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/webhooks/asaas",
              "host": ["{{base_url}}"],
              "path": ["api", "webhooks", "asaas"]
            },
            "description": "Testa webhook SEM token (deve retornar 401 Unauthorized)"
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code é 401 (sem token)', function () {",
                  "    pm.response.to.have.status(401);",
                  "});",
                  "",
                  "pm.test('Mensagem de erro apropriada', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property('detail', 'Unauthorized');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "Webhook - COM Token Válido",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "asaas-access-token",
                "value": "{{asaas_webhook_token}}",
                "description": "Token de acesso configurado no Asaas"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"event\": \"PAYMENT_CONFIRMED\",\n  \"payment\": {\n    \"id\": \"pay_test123\",\n    \"value\": 3290.00,\n    \"status\": \"CONFIRMED\",\n    \"customer\": \"cus_test456\",\n    \"externalReference\": \"order_789\"\n  }\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/webhooks/asaas",
              "host": ["{{base_url}}"],
              "path": ["api", "webhooks", "asaas"]
            },
            "description": "Testa webhook COM token válido (deve processar com sucesso)"
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code é 200 (token válido)', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Webhook processado com sucesso', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property('status', 'received');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "Webhook - Token Inválido",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "asaas-access-token",
                "value": "token_invalido_123",
                "description": "Token inválido para testar rejeição"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"event\": \"PAYMENT_CONFIRMED\",\n  \"payment\": {\n    \"id\": \"pay_test123\",\n    \"value\": 3290.00,\n    \"status\": \"CONFIRMED\"\n  }\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/webhooks/asaas",
              "host": ["{{base_url}}"],
              "path": ["api", "webhooks", "asaas"]
            },
            "description": "Testa rejeição de webhook com token inválido"
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code é 401 (token inválido)', function () {",
                  "    pm.response.to.have.status(401);",
                  "});",
                  "",
                  "pm.test('Mensagem de erro apropriada', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property('detail', 'Unauthorized');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "Webhook - Health Check",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/api/webhooks/asaas/health",
              "host": ["{{base_url}}"],
              "path": ["api", "webhooks", "asaas", "health"]
            },
            "description": "Verifica se o endpoint de webhook está ativo"
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code é 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Endpoint está saudável', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property('status', 'healthy');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Saques (Withdrawals)",
      "item": [
        {
          "name": "Listar Saques do Afiliado",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{auth_token}}",
                "description": "Token JWT do afiliado autenticado"
              }
            ],
            "url": {
              "raw": "{{base_url}}/api/affiliates/withdrawals?page=1&limit=20",
              "host": ["{{base_url}}"],
              "path": ["api", "affiliates", "withdrawals"],
              "query": [
                {
                  "key": "page",
                  "value": "1",
                  "description": "Página atual"
                },
                {
                  "key": "limit",
                  "value": "20",
                  "description": "Itens por página"
                },
                {
                  "key": "status",
                  "value": "",
                  "description": "Filtrar por status: pending, processing, completed, rejected",
                  "disabled": true
                },
                {
                  "key": "startDate",
                  "value": "",
                  "description": "Data inicial (ISO 8601)",
                  "disabled": true
                },
                {
                  "key": "endDate",
                  "value": "",
                  "description": "Data final (ISO 8601)",
                  "disabled": true
                }
              ]
            },
            "description": "Lista histórico de saques do afiliado autenticado com paginação e filtros"
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code é 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Retorna estrutura de withdrawals', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property('success', true);",
                  "    pm.expect(jsonData).to.have.property('data');",
                  "    pm.expect(jsonData.data).to.have.property('withdrawals');",
                  "    pm.expect(jsonData.data).to.have.property('pagination');",
                  "    pm.expect(jsonData.data).to.have.property('summary');",
                  "});",
                  "",
                  "pm.test('Paginação está correta', function () {",
                  "    var pagination = pm.response.json().data.pagination;",
                  "    pm.expect(pagination).to.have.property('page');",
                  "    pm.expect(pagination).to.have.property('limit');",
                  "    pm.expect(pagination).to.have.property('total');",
                  "    pm.expect(pagination).to.have.property('totalPages');",
                  "});",
                  "",
                  "pm.test('Summary contém totalizadores', function () {",
                  "    var summary = pm.response.json().data.summary;",
                  "    pm.expect(summary).to.have.property('totalCompleted');",
                  "    pm.expect(summary).to.have.property('totalPending');",
                  "    pm.expect(summary).to.have.property('totalRejected');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "Solicitar Novo Saque",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{auth_token}}",
                "description": "Token JWT do afiliado autenticado"
              },
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"amount\": 150.00,\n  \"pixKey\": \"11999999999\",\n  \"description\": \"Saque de comissões - Janeiro 2026\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/affiliates/withdrawals",
              "host": ["{{base_url}}"],
              "path": ["api", "affiliates", "withdrawals"]
            },
            "description": "Solicita um novo saque de comissões (mínimo R$ 50)"
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code é 201', function () {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "",
                  "pm.test('Saque criado com sucesso', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property('success', true);",
                  "    pm.expect(jsonData).to.have.property('data');",
                  "    pm.expect(jsonData.data).to.have.property('withdrawalId');",
                  "    pm.expect(jsonData.data).to.have.property('status', 'pending');",
                  "    pm.expect(jsonData.data).to.have.property('estimatedDate');",
                  "});",
                  "",
                  "pm.test('Salvar ID do saque', function () {",
                  "    var withdrawalId = pm.response.json().data.withdrawalId;",
                  "    pm.collectionVariables.set('withdrawal_id', withdrawalId);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "Saque - Valor Abaixo do Mínimo (deve falhar)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{auth_token}}",
                "description": "Token JWT do afiliado autenticado"
              },
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"amount\": 30.00,\n  \"pixKey\": \"11999999999\",\n  \"description\": \"Tentativa de saque abaixo do mínimo\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/affiliates/withdrawals",
              "host": ["{{base_url}}"],
              "path": ["api", "affiliates", "withdrawals"]
            },
            "description": "Testa validação de valor mínimo (R$ 50)"
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code é 400 (valor mínimo)', function () {",
                  "    pm.response.to.have.status(400);",
                  "});",
                  "",
                  "pm.test('Mensagem de erro apropriada', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property('success', false);",
                  "    pm.expect(jsonData).to.have.property('error');",
                  "    pm.expect(jsonData.error).to.include('mínimo');",
                  "    pm.expect(jsonData.error).to.include('50');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "Saque - Sem Chave PIX (deve falhar)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{auth_token}}",
                "description": "Token JWT do afiliado autenticado"
              },
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"amount\": 100.00,\n  \"description\": \"Tentativa sem chave PIX\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/affiliates/withdrawals",
              "host": ["{{base_url}}"],
              "path": ["api", "affiliates", "withdrawals"]
            },
            "description": "Testa validação de chave PIX obrigatória"
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code é 400 (sem PIX)', function () {",
                  "    pm.response.to.have.status(400);",
                  "});",
                  "",
                  "pm.test('Mensagem de erro apropriada', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property('success', false);",
                  "    pm.expect(jsonData).to.have.property('error');",
                  "    pm.expect(jsonData.error).to.include('PIX');",
                  "    pm.expect(jsonData.error).to.include('obrigatória');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "Saque - Sem Autenticação (deve falhar)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"amount\": 100.00,\n  \"pixKey\": \"11999999999\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/affiliates/withdrawals",
              "host": ["{{base_url}}"],
              "path": ["api", "affiliates", "withdrawals"]
            },
            "description": "Testa validação de autenticação obrigatória"
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code é 401 (não autenticado)', function () {",
                  "    pm.response.to.have.status(401);",
                  "});",
                  "",
                  "pm.test('Mensagem de erro apropriada', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property('success', false);",
                  "    pm.expect(jsonData).to.have.property('error');",
                  "    pm.expect(jsonData.error).to.include('autenticação');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "Filtrar Saques por Status",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{auth_token}}",
                "description": "Token JWT do afiliado autenticado"
              }
            ],
            "url": {
              "raw": "{{base_url}}/api/affiliates/withdrawals?status=completed",
              "host": ["{{base_url}}"],
              "path": ["api", "affiliates", "withdrawals"],
              "query": [
                {
                  "key": "status",
                  "value": "completed",
                  "description": "Filtrar apenas saques completados"
                }
              ]
            },
            "description": "Testa filtro por status de saque"
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code é 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Retorna apenas saques completados', function () {",
                  "    var withdrawals = pm.response.json().data.withdrawals;",
                  "    withdrawals.forEach(function(withdrawal) {",
                  "        pm.expect(withdrawal.status).to.equal('completed');",
                  "    });",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "Filtrar Saques por Período",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{auth_token}}",
                "description": "Token JWT do afiliado autenticado"
              }
            ],
            "url": {
              "raw": "{{base_url}}/api/affiliates/withdrawals?startDate=2026-01-01&endDate=2026-01-31",
              "host": ["{{base_url}}"],
              "path": ["api", "affiliates", "withdrawals"],
              "query": [
                {
                  "key": "startDate",
                  "value": "2026-01-01",
                  "description": "Data inicial"
                },
                {
                  "key": "endDate",
                  "value": "2026-01-31",
                  "description": "Data final"
                }
              ]
            },
            "description": "Testa filtro por período de datas"
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code é 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Retorna saques no período especificado', function () {",
                  "    var withdrawals = pm.response.json().data.withdrawals;",
                  "    var startDate = new Date('2026-01-01');",
                  "    var endDate = new Date('2026-01-31');",
                  "    ",
                  "    withdrawals.forEach(function(withdrawal) {",
                  "        var createdAt = new Date(withdrawal.created_at);",
                  "        pm.expect(createdAt).to.be.at.least(startDate);",
                  "        pm.expect(createdAt).to.be.at.most(endDate);",
                  "    });",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Pedidos",
      "item": [
        {
          "name": "Criar Pedido com Afiliado",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"customer_id\": \"customer_123\",\n  \"product_id\": \"product_456\",\n  \"total\": 3290.00,\n  \"referral_code\": \"{{referral_code}}\"\n}"
            },
            "url": {
              "raw": "{{api_url}}/orders",
              "host": ["{{api_url}}"],
              "path": ["orders"]
            },
            "description": "Cria um pedido vinculado a um afiliado via código de indicação"
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code é 201', function () {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "",
                  "pm.test('Pedido criado com afiliado vinculado', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property('id');",
                  "    pm.expect(jsonData).to.have.property('affiliate_n1_id');",
                  "    ",
                  "    // Salvar order_id para próximos testes",
                  "    pm.collectionVariables.set('order_id', jsonData.id);",
                  "    ",
                  "    // Validar hierarquia (Bug 01)",
                  "    pm.expect(jsonData.affiliate_n1_id).to.not.be.null;",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "Buscar Pedido por ID",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{api_url}}/orders/:id",
              "host": ["{{api_url}}"],
              "path": ["orders", ":id"],
              "variable": [
                {
                  "key": "id",
                  "value": "{{order_id}}",
                  "description": "ID do pedido"
                }
              ]
            },
            "description": "Busca um pedido específico e valida hierarquia de afiliados"
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code é 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Hierarquia de afiliados populada (Bug 01)', function () {",
                  "    var jsonData = pm.response.json();",
                  "    ",
                  "    // Validar que campos de hierarquia existem",
                  "    pm.expect(jsonData).to.have.property('affiliate_n1_id');",
                  "    pm.expect(jsonData).to.have.property('affiliate_n2_id');",
                  "    pm.expect(jsonData).to.have.property('affiliate_n3_id');",
                  "    ",
                  "    // N1 deve estar sempre preenchido se houver afiliado",
                  "    if (jsonData.affiliate_n1_id) {",
                  "        pm.expect(jsonData.affiliate_n1_id).to.not.be.null;",
                  "    }",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ]
        }
      ]
    }
  ]
}
